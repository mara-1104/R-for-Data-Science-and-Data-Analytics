<!DOCTYPE html>
<html>
<head>
    <title>NFT Viewer</title>
    <script src="https://cdn.jsdelivr.net/npm/web3@1.5.2/dist/web3.min.js"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
        }
        .container {
            text-align: center;
        }
        button {
            background-color: #4CAF50;
            color: white;
            padding: 10px 20px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            margin: 10px;
        }
        button:hover {
            background-color: #45a049;
        }
        #nftDisplay {
            margin-top: 20px;
            padding: 20px;
            border: 1px solid #ddd;
            border-radius: 8px;
        }
        .nft-details, .nft-image, .raw-data {
            margin: 20px 0;
            padding: 15px;
            border: 1px solid #eee;
            border-radius: 4px;
        }
        .raw-data pre {
            background-color: #f5f5f5;
            padding: 10px;
            border-radius: 4px;
            overflow-x: auto;
        }
        .nft-image svg {
            max-width: 100%;
            height: auto;
        }
        .error {
            color: red;
            margin: 10px 0;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>NFT Viewer</h1>
        <button id="connectWallet">Conectează Metamask</button>
        <button id="viewNFT">Vezi NFT</button>
        <div id="walletStatus"></div>
        <div id="nftDisplay"></div>
    </div>

    <script>
        // Adresa contractului NFT - înlocuiește cu adresa ta reală
        const contractAddress = "0x5FbDB2315678afecb367f032d93F642f64180aa3";
        
        // ABI-ul contractului - doar funcțiile de care avem nevoie
       const contractABI = [{"type":"constructor","inputs":[{"name":"initialOwner","type":"address","internalType":"address"}],"stateMutability":"nonpayable"},{"type":"function","name":"approve","inputs":[{"name":"to","type":"address","internalType":"address"},{"name":"tokenId","type":"uint256","internalType":"uint256"}],"outputs":[],"stateMutability":"nonpayable"},{"type":"function","name":"balanceOf","inputs":[{"name":"owner","type":"address","internalType":"address"}],"outputs":[{"name":"","type":"uint256","internalType":"uint256"}],"stateMutability":"view"},{"type":"function","name":"burn","inputs":[{"name":"tokenId","type":"uint256","internalType":"uint256"}],"outputs":[],"stateMutability":"nonpayable"},{"type":"function","name":"getApproved","inputs":[{"name":"tokenId","type":"uint256","internalType":"uint256"}],"outputs":[{"name":"","type":"address","internalType":"address"}],"stateMutability":"view"},{"type":"function","name":"isApprovedForAll","inputs":[{"name":"owner","type":"address","internalType":"address"},{"name":"operator","type":"address","internalType":"address"}],"outputs":[{"name":"","type":"bool","internalType":"bool"}],"stateMutability":"view"},{"type":"function","name":"name","inputs":[],"outputs":[{"name":"","type":"string","internalType":"string"}],"stateMutability":"view"},{"type":"function","name":"owner","inputs":[],"outputs":[{"name":"","type":"address","internalType":"address"}],"stateMutability":"view"},{"type":"function","name":"ownerOf","inputs":[{"name":"tokenId","type":"uint256","internalType":"uint256"}],"outputs":[{"name":"","type":"address","internalType":"address"}],"stateMutability":"view"},{"type":"function","name":"pause","inputs":[],"outputs":[],"stateMutability":"nonpayable"},{"type":"function","name":"paused","inputs":[],"outputs":[{"name":"","type":"bool","internalType":"bool"}],"stateMutability":"view"},{"type":"function","name":"renounceOwnership","inputs":[],"outputs":[],"stateMutability":"nonpayable"},{"type":"function","name":"safeMint","inputs":[{"name":"to","type":"address","internalType":"address"}],"outputs":[{"name":"","type":"uint256","internalType":"uint256"}],"stateMutability":"nonpayable"},{"type":"function","name":"safeTransferFrom","inputs":[{"name":"from","type":"address","internalType":"address"},{"name":"to","type":"address","internalType":"address"},{"name":"tokenId","type":"uint256","internalType":"uint256"}],"outputs":[],"stateMutability":"nonpayable"},{"type":"function","name":"safeTransferFrom","inputs":[{"name":"from","type":"address","internalType":"address"},{"name":"to","type":"address","internalType":"address"},{"name":"tokenId","type":"uint256","internalType":"uint256"},{"name":"data","type":"bytes","internalType":"bytes"}],"outputs":[],"stateMutability":"nonpayable"},{"type":"function","name":"setApprovalForAll","inputs":[{"name":"operator","type":"address","internalType":"address"},{"name":"approved","type":"bool","internalType":"bool"}],"outputs":[],"stateMutability":"nonpayable"},{"type":"function","name":"supportsInterface","inputs":[{"name":"interfaceId","type":"bytes4","internalType":"bytes4"}],"outputs":[{"name":"","type":"bool","internalType":"bool"}],"stateMutability":"view"},{"type":"function","name":"symbol","inputs":[],"outputs":[{"name":"","type":"string","internalType":"string"}],"stateMutability":"view"},{"type":"function","name":"tokenByIndex","inputs":[{"name":"index","type":"uint256","internalType":"uint256"}],"outputs":[{"name":"","type":"uint256","internalType":"uint256"}],"stateMutability":"view"},{"type":"function","name":"tokenOfOwnerByIndex","inputs":[{"name":"owner","type":"address","internalType":"address"},{"name":"index","type":"uint256","internalType":"uint256"}],"outputs":[{"name":"","type":"uint256","internalType":"uint256"}],"stateMutability":"view"},{"type":"function","name":"tokenURI","inputs":[{"name":"tokenId","type":"uint256","internalType":"uint256"}],"outputs":[{"name":"","type":"string","internalType":"string"}],"stateMutability":"view"},{"type":"function","name":"totalSupply","inputs":[],"outputs":[{"name":"","type":"uint256","internalType":"uint256"}],"stateMutability":"view"},{"type":"function","name":"transferFrom","inputs":[{"name":"from","type":"address","internalType":"address"},{"name":"to","type":"address","internalType":"address"},{"name":"tokenId","type":"uint256","internalType":"uint256"}],"outputs":[],"stateMutability":"nonpayable"},{"type":"function","name":"transferOwnership","inputs":[{"name":"newOwner","type":"address","internalType":"address"}],"outputs":[],"stateMutability":"nonpayable"},{"type":"function","name":"unpause","inputs":[],"outputs":[],"stateMutability":"nonpayable"},{"type":"event","name":"Approval","inputs":[{"name":"owner","type":"address","indexed":true,"internalType":"address"},{"name":"approved","type":"address","indexed":true,"internalType":"address"},{"name":"tokenId","type":"uint256","indexed":true,"internalType":"uint256"}],"anonymous":false},{"type":"event","name":"ApprovalForAll","inputs":[{"name":"owner","type":"address","indexed":true,"internalType":"address"},{"name":"operator","type":"address","indexed":true,"internalType":"address"},{"name":"approved","type":"bool","indexed":false,"internalType":"bool"}],"anonymous":false},{"type":"event","name":"BatchMetadataUpdate","inputs":[{"name":"_fromTokenId","type":"uint256","indexed":false,"internalType":"uint256"},{"name":"_toTokenId","type":"uint256","indexed":false,"internalType":"uint256"}],"anonymous":false},{"type":"event","name":"MetadataUpdate","inputs":[{"name":"_tokenId","type":"uint256","indexed":false,"internalType":"uint256"}],"anonymous":false},{"type":"event","name":"OwnershipTransferred","inputs":[{"name":"previousOwner","type":"address","indexed":true,"internalType":"address"},{"name":"newOwner","type":"address","indexed":true,"internalType":"address"}],"anonymous":false},{"type":"event","name":"Paused","inputs":[{"name":"account","type":"address","indexed":false,"internalType":"address"}],"anonymous":false},{"type":"event","name":"Transfer","inputs":[{"name":"from","type":"address","indexed":true,"internalType":"address"},{"name":"to","type":"address","indexed":true,"internalType":"address"},{"name":"tokenId","type":"uint256","indexed":true,"internalType":"uint256"}],"anonymous":false},{"type":"event","name":"Unpaused","inputs":[{"name":"account","type":"address","indexed":false,"internalType":"address"}],"anonymous":false},{"type":"error","name":"ERC721EnumerableForbiddenBatchMint","inputs":[]},{"type":"error","name":"ERC721IncorrectOwner","inputs":[{"name":"sender","type":"address","internalType":"address"},{"name":"tokenId","type":"uint256","internalType":"uint256"},{"name":"owner","type":"address","internalType":"address"}]},{"type":"error","name":"ERC721InsufficientApproval","inputs":[{"name":"operator","type":"address","internalType":"address"},{"name":"tokenId","type":"uint256","internalType":"uint256"}]},{"type":"error","name":"ERC721InvalidApprover","inputs":[{"name":"approver","type":"address","internalType":"address"}]},{"type":"error","name":"ERC721InvalidOperator","inputs":[{"name":"operator","type":"address","internalType":"address"}]},{"type":"error","name":"ERC721InvalidOwner","inputs":[{"name":"owner","type":"address","internalType":"address"}]},{"type":"error","name":"ERC721InvalidReceiver","inputs":[{"name":"receiver","type":"address","internalType":"address"}]},{"type":"error","name":"ERC721InvalidSender","inputs":[{"name":"sender","type":"address","internalType":"address"}]},{"type":"error","name":"ERC721NonexistentToken","inputs":[{"name":"tokenId","type":"uint256","internalType":"uint256"}]},{"type":"error","name":"ERC721OutOfBoundsIndex","inputs":[{"name":"owner","type":"address","internalType":"address"},{"name":"index","type":"uint256","internalType":"uint256"}]},{"type":"error","name":"EnforcedPause","inputs":[]},{"type":"error","name":"ExpectedPause","inputs":[]},{"type":"error","name":"OwnableInvalidOwner","inputs":[{"name":"owner","type":"address","internalType":"address"}]},{"type":"error","name":"OwnableUnauthorizedAccount","inputs":[{"name":"account","type":"address","internalType":"address"}]}];


        let web3;
        let contract;
        let userAccount;

        // Funcție pentru conectarea la Metamask
        async function connectWallet() {
            if (typeof window.ethereum !== 'undefined') {
                try {
                    // Cerem permisiunea de a conecta wallet-ul
                    const accounts = await window.ethereum.request({ method: 'eth_requestAccounts' });
                    userAccount = accounts[0];
                    
                    // Inițializăm Web3
                    web3 = new Web3(window.ethereum);
                    
                    // Inițializăm contractul
                    contract = new web3.eth.Contract(contractABI, contractAddress);
                    
                    document.getElementById('walletStatus').innerHTML = 
                        `Conectat: ${userAccount.substring(0,6)}...${userAccount.substring(38)}`;
                    
                } catch (error) {
                    console.error(error);
                    document.getElementById('walletStatus').innerHTML = 
                        `<div class="error">Eroare la conectare: ${error.message}</div>`;
                }
            } else {
                document.getElementById('walletStatus').innerHTML = 
                    '<div class="error">Te rog să instalezi Metamask!</div>';
            }
        }

        // Funcție pentru afișarea NFT-ului
        async function viewNFT() {
            if (!contract) {
                alert('Te rog să te conectezi mai întâi la Metamask!');
                return;
            }

            try {
                // Încercăm să vedem NFT-ul cu ID-ul 1
                const tokenId = 1;
                const owner = await contract.methods.ownerOf(tokenId).call();
                const tokenURI = await contract.methods.tokenURI(tokenId).call();

                console.log("Raw tokenURI:", tokenURI);

                // Funcție helper pentru decodare base64 sigură
                function safeAtob(str) {
                    if (!str) {
                        console.error("Empty string provided to safeAtob");
                        return "";
                    }
                    
                    // Curățăm string-ul de caractere invalide
                    str = str.trim();
                    // Adăugăm padding dacă lipsește
                    while (str.length % 4 !== 0) {
                        str += '=';
                    }
                    
                    console.log("Attempting to decode:", str);
                    
                    try {
                        const decoded = atob(str);
                        console.log("Successfully decoded:", decoded);
                        return decoded;
                    } catch (e) {
                        console.error("Base64 decode error:", e);
                        console.error("Failed string:", str);
                        throw e;
                    }
                }

                let metadata;
                let svgImage;

                try {
                    // Verificăm și procesăm tokenURI
                    console.log("Processing tokenURI:", tokenURI);
                    
                    let base64Data;
                    if (tokenURI.includes('base64,')) {
                        base64Data = tokenURI.split('base64,')[1];
                    } else {
                        base64Data = tokenURI;
                    }
                    console.log("Base64 data:", base64Data);
                    
                    // Decodăm Base64 în JSON
                    const decodedData = safeAtob(base64Data);
                    console.log("Decoded JSON:", decodedData);
                    
                    // Parsăm JSON-ul
                    metadata = JSON.parse(decodedData);
                    console.log("Parsed metadata:", metadata);

                    // Extragem Base64 din SVG (eliminăm prefixul data:image/svg+xml;base64,)
                    const svgBase64 = metadata.image.split('base64,')[1];
                    
                    // Decodăm SVG-ul
                    svgImage = safeAtob(svgBase64);
                    console.log("Decoded SVG:", svgImage);
                } catch (e) {
                    console.error("Processing error:", e);
                    throw new Error(`Error processing NFT data: ${e.message}`);
                }
                
                // Afișăm toate datele
                document.getElementById('nftDisplay').innerHTML = `
                    <h3>NFT #${tokenId}</h3>
                    <div class="nft-details">
                        <p><strong>Owner:</strong> ${owner}</p>
                        <p><strong>Name:</strong> ${metadata.name}</p>
                        <p><strong>Description:</strong> ${metadata.description}</p>
                        <h4>Attributes:</h4>
                        ${metadata.attributes.map(attr => 
                            `<p><strong>${attr.trait_type}:</strong> ${attr.value}</p>`
                        ).join('')}
                    </div>
                    <div class="nft-image">
                        <h4>Image:</h4>
                        ${svgImage}
                    </div>
                    <div class="raw-data">
                        <h4>Raw Metadata:</h4>
                        <pre>${JSON.stringify(metadata, null, 2)}</pre>
                    </div>
                `;
            } catch (error) {
                console.error(error);
                document.getElementById('nftDisplay').innerHTML = 
                    `<div class="error">Eroare la încărcarea NFT-ului: ${error.message}</div>`;
            }
        }

        // Atașăm event listeners la butoane
        document.getElementById('connectWallet').addEventListener('click', connectWallet);
        document.getElementById('viewNFT').addEventListener('click', viewNFT);

        // Ascultăm pentru schimbări în Metamask
        if (typeof window.ethereum !== 'undefined') {
            window.ethereum.on('accountsChanged', function (accounts) {
                userAccount = accounts[0];
                document.getElementById('walletStatus').innerHTML = 
                    `Conectat: ${userAccount.substring(0,6)}...${userAccount.substring(38)}`;
            });

            window.ethereum.on('chainChanged', function (chainId) {
                window.location.reload();
            });
        }
    </script>
</body>
</html>
